---
import Header from "../components/Header";
import Footer from "../components/Footer";
import "../styles/global.css";
import GoogleAnalytics from "../components/GoogleAnalytics.astro";
import FeedbackWidget from "../components/FeedbackWidget";
import BuyMeCoffeeWidget from "../components/BuyMeCoffeeWidget";

import "@fontsource/jetbrains-mono";

interface Props {
  title: string;
  description?: string;
  image?: string;
  appLayout?: boolean;
}

const {
  title,
  description = "The minimalist, real-time Agile Retrospective tool designed for high-performing engineering teams.",
  image = "/og-image.jpg",
  appLayout = false,
} = Astro.props;

const canonicalURL = new URL(
  Astro.url.pathname.replace(/\/$/, "") || "/",
  Astro.site,
);
const currentPath = Astro.url.pathname;
const gaMeasurementId = import.meta.env.PUBLIC_FIREBASE_MEASUREMENT_ID;
const isProd = import.meta.env.PROD;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    {
      isProd && gaMeasurementId && (
        <GoogleAnalytics measurementId={gaMeasurementId} />
      )
    }
    <link
      rel="icon"
      type="image/svg+xml"
      href={new URL("/favicon.svg", Astro.url)}
    />
    <link
      rel="icon"
      type="image/png"
      href={new URL("/favicon.png", Astro.url)}
      sizes="160x160"
    />
    <link rel="apple-touch-icon" href={new URL("/favicon.png", Astro.url)} />
    <link rel="shortcut icon" href={new URL("/favicon.png", Astro.url)} />
    <link rel="canonical" href={canonicalURL} />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta
      name="keywords"
      content="agile retrospective, scrum retro, sprint retrospective tool, developer tools, remote team collaboration, AI retrospective, start stop continue, online retrospective tool, team health check, scrum master tools, free retrospective, fun retro ideas, remote retrospective, engineering leadership, sprint planning"
    />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(image, Astro.url)} />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalURL} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={new URL(image, Astro.url)} />

    <script
      type="application/ld+json"
      set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        name: "Clear Retro",
        applicationCategory: "BusinessApplication",
        operatingSystem: "Web",
        offers: {
          "@type": "Offer",
          price: "0",
          priceCurrency: "USD",
        },
        applicationSubCategory: "Agile Retrospective Tool",
        featureList: [
          "AI Smart Add (Gemini Cloud)",
          "Numerical 0-5 Point Voting System",
          "AI-Generated Executive Board Summaries",
          "Professional PDF & Excel Exports",
          "Private & Focus Modes for Bias Prevention",
          "Real-time WebSocket Synchronization",
        ],
        description: description,
        author: {
          "@type": "Organization",
          name: "Clear Retro",
          url: "https://clearretro.com",
        },
      })}
    />

    <script is:inline>
      // Initialize theme early to prevent FOUC
      if (
        localStorage.theme === "dark" ||
        (!("theme" in localStorage) &&
          window.matchMedia("(prefers-color-scheme: dark)").matches)
      ) {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }
    </script>
    <slot name="head" />
  </head>
  <body
    class="bg-grid-pattern text-gray-900 dark:text-gray-100 transition-colors duration-200 antialiased selection:bg-brand-500 selection:text-white"
  >
    <div
      class="min-h-screen flex flex-col transition-colors duration-300 font-mono"
    >
      {!appLayout && <Header client:idle currentPath={currentPath} />}
      <main class="flex-grow">
        <slot />
      </main>
      {!appLayout && <Footer />}
      <FeedbackWidget client:idle />
      <BuyMeCoffeeWidget client:idle />
    </div>
  </body>
</html>
