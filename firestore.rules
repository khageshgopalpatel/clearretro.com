rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is the creator of the document
    function isCreator(resource) {
      return resource.data.createdBy == request.auth.uid;
    }

    // Boards: Authenticated users can read. Public boards can be read by anyone.
    match /boards/{boardId} {
      allow read: if isAuthenticated() || resource.data.isPublic == true;
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;
      allow update, delete: if isAuthenticated() && isCreator(resource);

      // Helper to check if parent board is public (requires a get() call, but necessary for security)
      function isBoardPublic() {
        return get(/databases/$(database)/documents/boards/$(boardId)).data.isPublic == true;
      }

      match /cards/{cardId} {
        allow read: if isAuthenticated() || isBoardPublic();
        allow create: if isAuthenticated() || isBoardPublic();
        allow update: if isAuthenticated() || isBoardPublic(); // Allow guests to vote/edit if public
        allow delete: if isAuthenticated() && isCreator(resource); // Only creators can delete (guests can't delete unless we track their ID locally in doc)

        match /replies/{replyId} {
          allow read: if isAuthenticated() || isBoardPublic();
          allow create: if isAuthenticated() || isBoardPublic();
          allow update, delete: if isAuthenticated() && isCreator(resource);
        }
      }

      // Presence: Allow anyone to write presence (temporary fix for legacy boards)
      match /presence/{userId} {
        allow read: if true;
        allow write: if true;
        allow delete: if true;
      }

      // Typing indicators: Allow anyone to write typing
      match /typing/{userId} {
        allow read: if true;
        allow write: if true;
        allow delete: if true;
      }
    }

    // Teams: Users can read teams they belong to, create teams, admins can update/delete
    match /teams/{teamId} {
      function isMemberOrAdmin() {
        return request.auth.uid in resource.data.admins;
      }

      allow read: if isAuthenticated() && isMemberOrAdmin();
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && isMemberOrAdmin();
      allow delete: if isAuthenticated() && isMemberOrAdmin();

      // Action Items: Team members can read, admins can create/update/delete
      match /action_items/{itemId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if isAuthenticated();
      }
    }
  }
}
